(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(t){if(t.ep)return;t.ep=!0;const i=r(t);fetch(t.href,i)}})();Cesium.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YjA3YzllNi0xMWE1LTRlZjYtOTc1NC03ZTY4M2QyMzVjMzMiLCJpZCI6MzIwNDM3LCJpYXQiOjE3NTIxODk2NTB9.qGb5hOcXISaOGIWG0CJfGOKA6wEO8x4xzvThJ9G-3Ww";const a=new Cesium.Viewer("cesiumContainer",{terrain:Cesium.Terrain.fromWorldTerrain(),requestRenderMode:!0,maximumRenderTimeChange:1/0});a.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(-122.4175,37.655,400),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-15)}});a.scene.globe.enableLighting=!0;a.scene.globe.depthTestAgainstTerrain=!0;a.scene.globe.terrainExaggeration=2;let u=!0,g=!0;setTimeout(()=>{document.getElementById("loadingOverlay").style.display="none"},2e3);const m=document.getElementById("uploadArea"),y=document.getElementById("fileInput");m.addEventListener("click",()=>y.click());m.addEventListener("dragover",e=>{e.preventDefault(),m.classList.add("dragover")});m.addEventListener("dragleave",()=>{m.classList.remove("dragover")});m.addEventListener("drop",e=>{e.preventDefault(),m.classList.remove("dragover"),v(e.dataTransfer.files)});y.addEventListener("change",e=>{v(e.target.files)});const p="http://localhost:5000";let c=new Map;function f(){const e=document.getElementById("active-layers-list"),n=document.getElementById("no-active-layers-msg"),r=document.getElementById("slopeLegend");e.innerHTML="",e.appendChild(n);let o=!1;c.size===0?n.style.display="block":(n.style.display="none",c.forEach((t,i)=>{const s=`
                <div class="active-layer-item" style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 13px;">${t.name}</span>
                        <div>
                            <button class="layer-btn" title="缩放至图层" data-layer-id="${i}">🔍</button>
                            <button class="layer-btn" title="移除图层" data-layer-id="${i}">❌</button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>👁️</span>
                        <input type="range" class="slider layer-opacity-slider" min="0" max="1" step="0.05" value="${t.layer.alpha}" data-layer-id="${i}">
                    </div>
                </div>
            `;e.insertAdjacentHTML("beforeend",s),t.category==="Slope Analysis"&&(o=!0)})),o?r.style.display="block":r.style.display="none",document.querySelectorAll(".layer-opacity-slider").forEach(t=>{t.addEventListener("input",i=>{const s=i.target.dataset.layerId;c.get(s)&&a.scene.requestRender()})}),document.querySelectorAll(".active-layer-item .layer-btn").forEach(t=>{t.addEventListener("click",i=>{const s=i.currentTarget.dataset.layerId,l=c.get(s);if(l){if(i.currentTarget.title==="Zoom to Layer")a.flyTo(l.layer);else if(i.currentTarget.title==="Remove Layer"){a.imageryLayers.remove(l.layer,!0),c.delete(s);const d=document.querySelector(`.dataset-btn[data-dataset-id='${l.id}']`);d&&(d.classList.remove("active"),d.textContent=`🛰️ ${l.name}`),f()}}})})}function I(e,n){const r=`layer-${e.id}`;if(c.has(r)){const o=c.get(r);a.imageryLayers.remove(o.layer,!0),c.delete(r),n.classList.remove("active"),n.textContent=`🛰️ ${e.name}`}else{console.log(`Loading Dataset: ${e.name}`);const o=new Cesium.SingleTileImageryProvider({url:e.image_url,rectangle:Cesium.Rectangle.fromDegrees(e.bbox_west,e.bbox_south,e.bbox_east,e.bbox_north)}),t=a.imageryLayers.addImageryProvider(o);c.set(r,{...e,layer:t}),a.flyTo(t),n.classList.add("active"),n.textContent=`✅ ${e.name}`}f()}async function h(){const e=document.getElementById("dataset-list");e.innerHTML='<p style="color: #888; font-size: 12px;">正在刷新数据列表...</p>';try{const r=await(await fetch(`${p}/api/datasets`)).json();if(e.innerHTML="",r.length===0){e.innerHTML='<p style="color: #888; font-size: 12px;">暂无数据，请先上传。</p>';return}r.forEach(o=>{const t=document.createElement("button");t.className="accordion-btn",t.textContent=`📁 ${o.category} (${o.datasets.length})`,t.title=o.description,e.appendChild(t);const i=document.createElement("div");i.className="accordion-panel",e.appendChild(i),o.datasets.forEach(s=>{const l=document.createElement("button");l.className="toggle-btn dataset-btn";let d="🛰️";s.source_type==="LOCAL"?d="💻":s.source_type==="GOOGLE_DRIVE"&&(d="☁️"),l.textContent=`${d} ${s.name}`,l.title=`Load/Unload ${s.name}`,l.dataset.datasetId=s.id;const E=`layer-${s.id}`;c.has(E)&&(l.classList.add("active"),l.textContent=`✅ ${s.name}`),l.addEventListener("click",C=>{C.stopPropagation(),I(s,l)}),i.appendChild(l)}),t.addEventListener("click",function(){this.classList.toggle("active");const s=this.nextElementSibling;s.style.maxHeight?s.style.maxHeight=null:s.style.maxHeight=s.scrollHeight+"px"})})}catch(n){console.error("Retrieving Data List Failed:",n),e.innerHTML='<p style="color: #f00; font-size: 12px;">Failed to Load Data List</p>'}}document.addEventListener("DOMContentLoaded",h);async function v(e){if(e.length===0){alert("Please Select a File");return}const n=e[0];document.getElementById("loadingOverlay").style.display="flex";const r=new FormData;r.append("file",n);try{const o=await fetch(`${p}/upload-geotiff`,{method:"POST",body:r}),t=await o.json();if(o.ok&&t.success)alert(t.message),h();else throw new Error(t.error||"Upload Failed")}catch(o){console.error("Upload or Process Error:",o),alert(`Process Failed: ${o.message}`)}finally{document.getElementById("loadingOverlay").style.display="none"}}document.getElementById("terrainScale").addEventListener("input",e=>{const n=parseFloat(e.target.value);document.getElementById("terrainScaleValue").textContent=n.toFixed(1),console.log(n),a.scene.globe.terrainExaggeration=n,a.scene.requestRender()});document.getElementById("imageryAlpha").addEventListener("input",e=>{const n=parseFloat(e.target.value);document.getElementById("imageryAlphaValue").textContent=n.toFixed(1),a.imageryLayers.length>0&&(a.imageryLayers.get(0).alpha=n)});document.getElementById("slopeAlpha").addEventListener("input",e=>{const n=parseFloat(e.target.value);document.getElementById("slopeAlphaValue").textContent=n.toFixed(1)});document.getElementById("toggleImagery").addEventListener("click",function(){this.classList.toggle("active"),g=!g,a.imageryLayers.length>0&&(a.imageryLayers.get(0).show=g)});document.getElementById("toggleSlope").addEventListener("click",function(){this.classList.toggle("active"),u=!u,document.getElementById("slopeLegend").style.display=u?"block":"none"});document.getElementById("toggleContour").addEventListener("click",function(){this.classList.toggle("active")});const L=document.getElementById("toggleShadow");a.scene.globe.enableLighting&&L.classList.add("active");L.addEventListener("click",function(){this.classList.toggle("active");const e=this.classList.contains("active");if(a.scene.globe.enableLighting=e,e){const n=Cesium.JulianDate.fromIso8601("2025-07-12T16:00:00Z");a.clock.currentTime=n,a.clock.shouldAnimate=!1}a.scene.requestRender()});document.getElementById("viewOverview").addEventListener("click",()=>{a.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(116.3974,39.9093,5e4),orientation:{heading:0,pitch:Cesium.Math.toRadians(-90),roll:0}})});document.getElementById("viewDetail").addEventListener("click",()=>{a.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(116.3974,39.9093,2e3),orientation:{heading:0,pitch:Cesium.Math.toRadians(-30),roll:0}})});document.getElementById("viewFly").addEventListener("click",()=>{const e=[{lon:116.37,lat:39.88,height:1500},{lon:116.4,lat:39.9,height:2e3},{lon:116.42,lat:39.92,height:1800},{lon:116.39,lat:39.91,height:1600}];let n=0;function r(){n>=e.length&&(n=0);const o=e[n];a.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(o.lon,o.lat,o.height),duration:3,complete:()=>{n++,a.scene.requestRender(),setTimeout(r,1e3)}})}r()});const b=new Cesium.ScreenSpaceEventHandler(a.scene.canvas);b.setInputAction(e=>{const n=a.camera.pickEllipsoid(e.endPosition,a.scene.globe.ellipsoid);if(n){const r=Cesium.Cartographic.fromCartesian(n),o=Cesium.Math.toDegrees(r.longitude),t=Cesium.Math.toDegrees(r.latitude),i=a.terrainProvider;Cesium.sampleTerrainMostDetailed(i,[r]).then(s=>{const l=s[0].height||0;document.getElementById("longitude").textContent=o.toFixed(6)+"°",document.getElementById("latitude").textContent=t.toFixed(6)+"°",document.getElementById("elevation").textContent=l.toFixed(1)+" m";const d=Math.random()*30;document.getElementById("slope").textContent=d.toFixed(1)+"°",document.getElementById("dataPanel").classList.add("show")})}},Cesium.ScreenSpaceEventType.MOUSE_MOVE);document.addEventListener("keydown",e=>{switch(e.key){case"h":document.querySelector(".control-panel").style.display=document.querySelector(".control-panel").style.display==="none"?"block":"none";break;case"r":a.camera.flyHome(1.5);break;case"f":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break}});
