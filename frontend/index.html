<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoTIFF 3Dåœ°çƒå¯è§†åŒ–ç³»ç»Ÿ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.131.0/Cesium.js"></script>
  <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.131.0/Widgets/widgets.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      background: #000;
    }

    #cesiumContainer {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      min-width: 300px;
      max-width: 500px;
      color: white;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .control-panel h3 {
      margin-bottom: 15px;
      font-size: 16px;
      color: #00d4ff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #aaa;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #00d4ff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #00d4ff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .toggle-btn {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 6px;
      color: #00d4ff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
    }

    .toggle-btn:hover {
      background: rgba(0, 212, 255, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }

    .toggle-btn.active {
      background: rgba(0, 212, 255, 0.3);
      border-color: #00d4ff;
    }

    /* æ•°æ®é¢æ¿ */
    .data-panel {
      position: absolute;
      top: 50px;
      right: 20px;
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      color: white;
      display: none;
      min-width: 250px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .data-panel.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .data-item {
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .data-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .data-value {
      font-size: 18px;
      font-weight: bold;
      color: #00d4ff;
    }

    /* åŠ è½½æç¤º */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid rgba(0, 212, 255, 0.2);
      border-top: 3px solid #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      border: 2px dashed rgba(0, 212, 255, 0.5);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.05);
    }

    .upload-area.dragover {
      border-color: #00ff88;
      background: rgba(0, 255, 136, 0.1);
    }

    .file-input {
      display: none;
    }

    /* å›¾ä¾‹ */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(20, 20, 30, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      color: white;
      font-size: 12px;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #00d4ff;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border-radius: 3px;
    }

    /* æ‰‹é£ç´æ ·å¼ */
    .accordion-btn {
      width: 100%;
      padding: 12px;
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.4);
      border-radius: 6px;
      color: #00d4ff;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-weight: bold;
      margin-top: 10px;
    }
    .accordion-btn:hover {
      background: rgba(0, 212, 255, 0.25);
    }
    .accordion-panel {
      padding: 0 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
  </style>
</head>
<body>
<div id="cesiumContainer"></div>

<!-- æ§åˆ¶é¢æ¿ -->
<div class="control-panel">
  <h3>æ•°æ®æ§åˆ¶</h3>

  <div class="upload-area" id="uploadArea">
    <div>ğŸ“ æ‹–æ‹½GeoTIFFæ–‡ä»¶åˆ°æ­¤å¤„</div>
    <div style="margin-top: 10px; font-size: 12px; color: #888;">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
    <input type="file" id="fileInput" class="file-input" accept=".tif,.tiff,.geotiff" multiple>
  </div>

  <div class="control-group" id="dataset-list-container">
    <label>å¯ç”¨æ•°æ®é›†</label>
    <div id="dataset-list" style="max-height: 150px; overflow-y: auto;">
      <p style="color: #888; font-size: 12px;">æ­£åœ¨åŠ è½½æ•°æ®åˆ—è¡¨...</p>
    </div>
  </div>

  <div class="control-group" id="active-layers-container">
    <label>å·²åŠ è½½å›¾å±‚</label>
    <div id="active-layers-list" style="max-height: 200px; overflow-y: auto;">
      <p id="no-active-layers-msg" style="color: #888; font-size: 12px;">å½“å‰æ— åŠ è½½å›¾å±‚ã€‚</p>
    </div>
  </div>

  <div class="control-group">
    <label>åœ°å½¢å¤¸å¤§ç³»æ•°: <span id="terrainScaleValue">2.0</span></label>
    <input type="range" class="slider" id="terrainScale" min="0.5" max="5" step="0.1" value="2">
  </div>

  <div class="control-group">
    <label>å½±åƒé€æ˜åº¦: <span id="imageryAlphaValue">1.0</span></label>
    <input type="range" class="slider" id="imageryAlpha" min="0" max="1" step="0.1" value="1">
  </div>

  <div class="control-group">
    <button class="toggle-btn" id="toggleContour">ğŸ“ˆ ç­‰é«˜çº¿</button>
    <button class="toggle-btn" id="toggleShadow">ğŸŒ… åœ°å½¢é˜´å½±</button>
  </div>

  <div class="control-group">
    <label>è§†è§’æ¨¡å¼</label>
    <button class="toggle-btn" id="viewOverview">ğŸŒ æ€»è§ˆ</button>
    <button class="toggle-btn" id="viewDetail">ğŸ” ç»†èŠ‚</button>
    <button class="toggle-btn" id="viewFly">âœˆï¸ é£è¡Œ</button>
  </div>
</div>

<!-- æ•°æ®æ˜¾ç¤ºé¢æ¿ -->
<div class="data-panel" id="dataPanel">
  <h3 style="color: #00d4ff; margin-bottom: 15px;">ä½ç½®ä¿¡æ¯</h3>
  <div class="data-item">
    <div class="data-label">ç»åº¦</div>
    <div class="data-value" id="longitude">-</div>
  </div>
  <div class="data-item">
    <div class="data-label">çº¬åº¦</div>
    <div class="data-value" id="latitude">-</div>
  </div>
  <div class="data-item">
    <div class="data-label">é«˜ç¨‹</div>
    <div class="data-value" id="elevation">-</div>
  </div>
  <div class="data-item">
    <div class="data-label">å¡åº¦</div>
    <div class="data-value" id="slope">-</div>
  </div>
</div>

<!-- å›¾ä¾‹ -->
<div class="legend" id="slopeLegend" style="display: none;">
  <div class="legend-title">å¡åº¦å›¾ä¾‹</div>
  <div class="legend-item">
    <div class="legend-color" style="background: #00ff00;"></div>
    <span>0Â° - 5Â° å¹³ç¼“</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #ffff00;"></div>
    <span>5Â° - 15Â° ç¼“å¡</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #ff8800;"></div>
    <span>15Â° - 25Â° é™¡å¡</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #ff0000;"></div>
    <span>&gt; 25Â° æé™¡</span>
  </div>
</div>

<!-- åŠ è½½æç¤º -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>åˆå§‹åŒ–3Dåœ°çƒ...</div>
  </div>
</div>

<script type="module">
  // Cesiumé…ç½®
  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YjA3YzllNi0xMWE1LTRlZjYtOTc1NC03ZTY4M2QyMzVjMzMiLCJpZCI6MzIwNDM3LCJpYXQiOjE3NTIxODk2NTB9.qGb5hOcXISaOGIWG0CJfGOKA6wEO8x4xzvThJ9G-3Ww';

  // åˆå§‹åŒ–Cesium Viewer
  // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
  const viewer = new Cesium.Viewer('cesiumContainer', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    // --- æ·»åŠ ä»¥ä¸‹ä¸¤è¡Œ ---
    requestRenderMode: true, // å¼€å¯æŒ‰éœ€æ¸²æŸ“
    maximumRenderTimeChange: Infinity, // ä»…åœ¨æ•°æ®æˆ–è§†å›¾å˜åŒ–æ—¶æ¸²æŸ“
  });

  // Fly the camera to San Francisco at the given longitude, latitude, and height.
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(-122.4175, 37.655, 400),
    orientation: {
      heading: Cesium.Math.toRadians(0.0),
      pitch: Cesium.Math.toRadians(-15.0),
    }
  });

  // Add Cesium OSM Buildings, a global 3D buildings layer.
  // const buildingTileset = await Cesium.createOsmBuildingsAsync();
  // viewer.scene.primitives.add(buildingTileset);

  // è®¾ç½®åˆå§‹è§†è§’
  viewer.scene.globe.enableLighting = true;
  viewer.scene.globe.depthTestAgainstTerrain = true;
  // å°†åœ°å½¢å¤¸å¤§ç³»æ•°è®¾ä¸º 2.0
  viewer.scene.globe.terrainExaggeration = 2.0;

  // æ•°æ®å­˜å‚¨
  let loadedDatasets = [];
  let currentTerrainScale = 2.0;
  let slopeLayerVisible = true;
  let imageryLayerVisible = true;

  // éšè—åŠ è½½æç¤º
  setTimeout(() => {
    document.getElementById('loadingOverlay').style.display = 'none';
  }, 2000);

  // æ–‡ä»¶ä¸Šä¼ å¤„ç†
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');

  uploadArea.addEventListener('click', () => fileInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
  });

  const API_BASE_URL = 'http://localhost:5000';
  // let currentImageryLayer = null; // ç”¨äºè·Ÿè¸ªå½“å‰æ˜¾ç¤ºçš„å›¾å±‚
  let activeLayers = new Map(); // ä½¿ç”¨ Map æ•°æ®ç»“æ„ï¼Œç”¨å›¾å±‚idä½œä¸ºé”®ï¼Œæ–¹ä¾¿å¢åˆ 

  // /**
  //  * åœ¨Cesiumä¸­åŠ è½½æŒ‡å®šçš„æ•°æ®é›†å›¾å±‚
  //  * @param {object} dataset - åŒ…å« name, image_url, bbox ç­‰ä¿¡æ¯çš„æ•°æ®é›†å¯¹è±¡
  //  */
  // async function loadDatasetOnMap(dataset) {
  //   // å¦‚æœå½“å‰å·²æœ‰å›¾å±‚ï¼Œå…ˆç§»é™¤
  //   if (currentImageryLayer) {
  //     viewer.imageryLayers.remove(currentImageryLayer, true);
  //     currentImageryLayer = null;
  //   }
  //
  //   console.log(`æ­£åœ¨åŠ è½½æ•°æ®é›†: ${dataset.name}`);
  //   try {
  //       // æ­¥éª¤ 1: åˆ›å»ºå½±åƒæä¾›è€… (ImageryProvider)
  //       // è¿™ä¸ªå¯¹è±¡è´Ÿè´£ä»æŒ‡å®šçš„URLå’ŒèŒƒå›´å†…æä¾›å›¾åƒæ•°æ®ã€‚
  //       const imageryProvider = new Cesium.SingleTileImageryProvider({
  //         url: dataset.image_url,
  //         rectangle: Cesium.Rectangle.fromDegrees(
  //                 dataset.bbox_west,
  //                 dataset.bbox_south,
  //                 dataset.bbox_east,
  //                 dataset.bbox_north
  //         )
  //       });
  //
  //       // æ­¥éª¤ 2: ä½¿ç”¨è¯¥æä¾›è€…æ˜¾å¼åˆ›å»ºä¸€ä¸ªå½±åƒå›¾å±‚ (ImageryLayer)
  //       // è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾å±‚å¯¹è±¡ï¼ŒåŒ…å«äº†æ¸²æŸ“æ‰€éœ€çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚
  //       const newLayer = new Cesium.ImageryLayer(imageryProvider);
  //
  //       // æ­¥éª¤ 3: å°†åˆ›å»ºå¥½çš„ã€å®Œæ•´çš„å›¾å±‚å¯¹è±¡æ·»åŠ åˆ° Viewer ä¸­
  //       viewer.imageryLayers.add(newLayer);
  //
  //       // æ­¥éª¤ 4: é£è¡Œåˆ°æ–°æ·»åŠ å›¾å±‚çš„èŒƒå›´ï¼Œè®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»çœ‹åˆ°æ•°æ®
  //       await viewer.flyTo(newLayer);
  //
  //       console.log("æˆåŠŸæ·»åŠ GeoTIFFå›¾å±‚ï¼");
  //
  //     } catch (error) {
  //       console.error("ä¸Šä¼ æˆ–å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:", error);
  //       alert(`å¤„ç†å¤±è´¥: ${error.message}`);
  //     } finally {
  //       document.getElementById('loadingOverlay').style.display = 'none';
  //     }
  // }

  /**
   * æ–°å¢ï¼šæ¸²æŸ“â€œå·²åŠ è½½å›¾å±‚â€é¢æ¿çš„å‡½æ•°
   */
  function renderActiveLayersPanel() {
    const listContainer = document.getElementById('active-layers-list');
    const noLayersMsg = document.getElementById('no-active-layers-msg');
    const slopeLegend = document.getElementById('slopeLegend'); // è·å–å›¾ä¾‹å…ƒç´ 

    listContainer.innerHTML = ''; // æ¸…ç©º
    listContainer.appendChild(noLayersMsg); // å…ˆæŠŠæç¤ºæ¶ˆæ¯åŠ å›å»

    let isSlopeLayerActive = false; // æ–°å¢ä¸€ä¸ªæ ‡å¿—ä½

    if (activeLayers.size === 0) {
      noLayersMsg.style.display = 'block';
    } else {
      noLayersMsg.style.display = 'none';
      activeLayers.forEach((layerData, layerId) => {
        const layerControlHTML = `
                <div class="active-layer-item" style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 13px;">${layerData.name}</span>
                        <div>
                            <button class="layer-btn" title="ç¼©æ”¾è‡³å›¾å±‚" data-layer-id="${layerId}">ğŸ”</button>
                            <button class="layer-btn" title="ç§»é™¤å›¾å±‚" data-layer-id="${layerId}">âŒ</button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ‘ï¸</span>
                        <input type="range" class="slider layer-opacity-slider" min="0" max="1" step="0.05" value="${layerData.layer.alpha}" data-layer-id="${layerId}">
                    </div>
                </div>
            `;
        listContainer.insertAdjacentHTML('beforeend', layerControlHTML);
        // --- æ–°å¢é€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¡åº¦å›¾å±‚å¤„äºæ¿€æ´»çŠ¶æ€ ---
        if (layerData.category === 'å¡åº¦åˆ†æ') {
          isSlopeLayerActive = true;
        }
      });
    }

    // --- æ–°å¢é€»è¾‘ï¼šæ ¹æ®æ ‡å¿—ä½ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå›¾ä¾‹ ---
    if (isSlopeLayerActive) {
      slopeLegend.style.display = 'block';
    } else {
      slopeLegend.style.display = 'none';
    }

    // --- ä¸ºæ–°ç”Ÿæˆçš„æ§ä»¶ç»‘å®šäº‹ä»¶ ---
    document.querySelectorAll('.layer-opacity-slider').forEach(slider => {
      slider.addEventListener('input', (e) => {
        const layerId = e.target.dataset.layerId;
        const layerData = activeLayers.get(layerId);
        if (layerData) {
          viewer.scene.requestRender(); // <-- æ‰‹åŠ¨è¯·æ±‚æ¸²æŸ“ä»¥æ›´æ–°è§†å›¾
        }
      });
    });

    document.querySelectorAll('.active-layer-item .layer-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const layerId = e.currentTarget.dataset.layerId;
        const layerData = activeLayers.get(layerId);
        if (!layerData) return;

        if (e.currentTarget.title === 'ç¼©æ”¾è‡³å›¾å±‚') {
          viewer.flyTo(layerData.layer);
        } else if (e.currentTarget.title === 'ç§»é™¤å›¾å±‚') {
          viewer.imageryLayers.remove(layerData.layer, true);
          activeLayers.delete(layerId);
          // æ›´æ–°å¯ç”¨æ•°æ®é›†åˆ—è¡¨ä¸­çš„æŒ‰é’®çŠ¶æ€
          const sourceButton = document.querySelector(`.dataset-btn[data-dataset-id='${layerData.id}']`);
          if (sourceButton) {
            sourceButton.classList.remove('active');
            sourceButton.textContent = `ğŸ›°ï¸ ${layerData.name}`;
          }
          renderActiveLayersPanel(); // é‡æ–°æ¸²æŸ“é¢æ¿
        }
      });
    });
  }

  /**
   * é‡æ„: â€œå¯ç”¨æ•°æ®é›†â€æŒ‰é’®çš„ç‚¹å‡»é€»è¾‘
   * @param {object} dataset - æ•°æ®é›†å¯¹è±¡
   * @param {HTMLElement} buttonElement - è¢«ç‚¹å‡»çš„æŒ‰é’®
   */
  function toggleDatasetOnMap(dataset, buttonElement) {
    const layerId = `layer-${dataset.id}`;

    // å¦‚æœå›¾å±‚å·²åœ¨åœ°å›¾ä¸Šï¼Œåˆ™ç§»é™¤å®ƒ
    if (activeLayers.has(layerId)) {
      const layerData = activeLayers.get(layerId);
      viewer.imageryLayers.remove(layerData.layer, true);
      activeLayers.delete(layerId);
      buttonElement.classList.remove('active');
      buttonElement.textContent = `ğŸ›°ï¸ ${dataset.name}`;
    }
    // å¦‚æœæ˜¯æ–°å›¾å±‚ï¼Œåˆ™æ·»åŠ åˆ°åœ°å›¾
    else {
      console.log(`æ­£åœ¨åŠ è½½æ•°æ®é›†: ${dataset.name}`);
      const imageryProvider = new Cesium.SingleTileImageryProvider({
        url: dataset.image_url,
        rectangle: Cesium.Rectangle.fromDegrees(
                dataset.bbox_west, dataset.bbox_south,
                dataset.bbox_east, dataset.bbox_north
        )
      });

      const newLayer = viewer.imageryLayers.addImageryProvider(imageryProvider);
      activeLayers.set(layerId, { ...dataset, layer: newLayer });

      viewer.flyTo(newLayer);
      buttonElement.classList.add('active');
      buttonElement.textContent = `âœ… ${dataset.name}`;
    }

    // æ— è®ºæ·»åŠ æˆ–åˆ é™¤ï¼Œéƒ½é‡æ–°æ¸²æŸ“â€œå·²åŠ è½½å›¾å±‚â€é¢æ¿
    renderActiveLayersPanel();
  }

  /**
   * ä»åç«¯è·å–æ•°æ®é›†åˆ—è¡¨å¹¶æ¸²æŸ“åˆ°UI
   */
  async function fetchAndDisplayDatasets() {
    const listContainer = document.getElementById('dataset-list');
    listContainer.innerHTML = '<p style="color: #888; font-size: 12px;">æ­£åœ¨åˆ·æ–°æ•°æ®åˆ—è¡¨...</p>';

    try {
      const response = await fetch(`${API_BASE_URL}/api/datasets`);
      const groupedDatasets = await response.json(); // ç°åœ¨è·å–çš„æ˜¯åˆ†ç»„æ•°æ®

      listContainer.innerHTML = ''; // æ¸…ç©º

      if (groupedDatasets.length === 0) {
        listContainer.innerHTML = '<p style="color: #888; font-size: 12px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ ã€‚</p>';
        return;
      }

      // --- éå†åˆ†ç»„æ¥åˆ›å»ºæ‰‹é£ç´ UI ---
      groupedDatasets.forEach(group => {
        // 1. åˆ›å»ºåˆ†ç±»æŒ‰é’®
        const accordionBtn = document.createElement('button');
        accordionBtn.className = 'accordion-btn';
        accordionBtn.textContent = `ğŸ“ ${group.category} (${group.datasets.length})`;
        accordionBtn.title = group.description;
        listContainer.appendChild(accordionBtn);

        // 2. åˆ›å»ºåˆ†ç±»ä¸‹çš„æ•°æ®é›†é¢æ¿
        const panel = document.createElement('div');
        panel.className = 'accordion-panel';
        listContainer.appendChild(panel);

        // 3. å°†æ•°æ®é›†æŒ‰é’®æ·»åŠ åˆ°é¢æ¿ä¸­
        group.datasets.forEach(dataset => {
          const button = document.createElement('button');
          button.className = 'toggle-btn dataset-btn';
          // --- æ–°å¢ï¼šæ ¹æ® source_type æ·»åŠ å›¾æ ‡ ---
          let icon = 'ğŸ›°ï¸'; // é»˜è®¤å›¾æ ‡
          if (dataset.source_type === 'LOCAL') {
            icon = 'ğŸ’»'; // æœ¬åœ°æ–‡ä»¶çš„å›¾æ ‡
          } else if (dataset.source_type === 'GOOGLE_DRIVE') {
            icon = 'â˜ï¸'; // Google Drive æ–‡ä»¶çš„å›¾æ ‡
          }
          button.textContent = `${icon} ${dataset.name}`;
          button.title = `åŠ è½½/å¸è½½ ${dataset.name}`;
          button.dataset.datasetId = dataset.id;

          // æ£€æŸ¥å›¾å±‚æ˜¯å¦å·²åœ¨ activeLayers ä¸­ï¼Œä»¥ä¿æŒæŒ‰é’®çŠ¶æ€
          const layerId = `layer-${dataset.id}`;
          if (activeLayers.has(layerId)) {
            button.classList.add('active');
            button.textContent = `âœ… ${dataset.name}`;
          }

          button.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ‰‹é£ç´æŒ‰é’®
            toggleDatasetOnMap(dataset, button);
          });
          panel.appendChild(button);
        });

        // 4. ä¸ºåˆ†ç±»æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä»¥å±•å¼€/æŠ˜å é¢æ¿
        accordionBtn.addEventListener('click', function() {
          this.classList.toggle('active');
          const panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
          } else {
            // è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ä»¥å®¹çº³æ‰€æœ‰å†…å®¹
            panel.style.maxHeight = panel.scrollHeight + "px";
          }
        });
      });

    } catch (error) {
      console.error("è·å–æ•°æ®é›†åˆ—è¡¨å¤±è´¥:", error);
      listContainer.innerHTML = '<p style="color: #f00; font-size: 12px;">åŠ è½½åˆ—è¡¨å¤±è´¥ï¼</p>';
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆåï¼Œç«‹å³è·å–å¹¶æ˜¾ç¤ºæ•°æ®é›†åˆ—è¡¨
  document.addEventListener('DOMContentLoaded', fetchAndDisplayDatasets);

  // async function handleFiles(files) {
  //   if (files.length === 0) {
  //     alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
  //     return;
  //   }
  //   const file = files[0];
  //   document.getElementById('loadingOverlay').style.display = 'flex';
  //
  //   // åˆ›å»º FormData æ¥åŒ…è£…æ–‡ä»¶
  //   const formData = new FormData();
  //   formData.append('file', file);
  //
  //   try {
  //     // ä½¿ç”¨ fetch API å°†æ–‡ä»¶ POST åˆ°æ‚¨çš„åç«¯æœåŠ¡å™¨
  //     const response = await fetch('http://localhost:5000/upload-geotiff', {
  //       method: 'POST',
  //       body: formData,
  //     });
  //
  //     if (!response.ok) {
  //       throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.statusText}`);
  //     }
  //
  //     const data = await response.json(); // è§£æåç«¯è¿”å›çš„JSON
  //
  //     // ===================================================================
  //     // ã€é‡è¦ä¿®å¤ã€‘é‡‡ç”¨æ›´ç¨³å¥çš„å›¾å±‚åˆ›å»ºä¸æ·»åŠ æ–¹å¼
  //     // ===================================================================
  //
  //     // æ­¥éª¤ 1: åˆ›å»ºå½±åƒæä¾›è€… (ImageryProvider)
  //     // è¿™ä¸ªå¯¹è±¡è´Ÿè´£ä»æŒ‡å®šçš„URLå’ŒèŒƒå›´å†…æä¾›å›¾åƒæ•°æ®ã€‚
  //     const imageryProvider = new Cesium.SingleTileImageryProvider({
  //       url: data.imageUrl,
  //       rectangle: Cesium.Rectangle.fromDegrees(
  //               data.bbox[0],
  //               data.bbox[1],
  //               data.bbox[2],
  //               data.bbox[3]
  //       )
  //     });
  //
  //     // æ­¥éª¤ 2: ä½¿ç”¨è¯¥æä¾›è€…æ˜¾å¼åˆ›å»ºä¸€ä¸ªå½±åƒå›¾å±‚ (ImageryLayer)
  //     // è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾å±‚å¯¹è±¡ï¼ŒåŒ…å«äº†æ¸²æŸ“æ‰€éœ€çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚
  //     const newLayer = new Cesium.ImageryLayer(imageryProvider);
  //
  //     // æ­¥éª¤ 3: å°†åˆ›å»ºå¥½çš„ã€å®Œæ•´çš„å›¾å±‚å¯¹è±¡æ·»åŠ åˆ° Viewer ä¸­
  //     viewer.imageryLayers.add(newLayer);
  //
  //     // æ­¥éª¤ 4: é£è¡Œåˆ°æ–°æ·»åŠ å›¾å±‚çš„èŒƒå›´ï¼Œè®©ç”¨æˆ·å¯ä»¥ç«‹åˆ»çœ‹åˆ°æ•°æ®
  //     await viewer.flyTo(newLayer);
  //
  //     console.log("æˆåŠŸæ·»åŠ GeoTIFFå›¾å±‚ï¼");
  //
  //   } catch (error) {
  //     console.error("ä¸Šä¼ æˆ–å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:", error);
  //     alert(`å¤„ç†å¤±è´¥: ${error.message}`);
  //   } finally {
  //     document.getElementById('loadingOverlay').style.display = 'none';
  //   }
  // }
  // ===================================================================
  // ä¿®æ”¹: æ–‡ä»¶ä¸Šä¼ å¤„ç†é€»è¾‘
  // ===================================================================

  async function handleFiles(files) {
    if (files.length === 0) {
      alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
      return;
    }
    const file = files[0];
    document.getElementById('loadingOverlay').style.display = 'flex';

    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch(`${API_BASE_URL}/upload-geotiff`, {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok && result.success) {
        alert(result.message); // å¼¹å‡ºæˆåŠŸæç¤º
        fetchAndDisplayDatasets(); // ä¸Šä¼ æˆåŠŸåï¼Œåˆ·æ–°æ•°æ®é›†åˆ—è¡¨
      } else {
        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
      }

    } catch (error) {
      console.error("ä¸Šä¼ æˆ–å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:", error);
      alert(`å¤„ç†å¤±è´¥: ${error.message}`);
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  // æ§åˆ¶é¢æ¿äº‹ä»¶
  document.getElementById('terrainScale').addEventListener('input', (e) => {
    const newExaggeration = parseFloat(e.target.value);
    document.getElementById('terrainScaleValue').textContent = newExaggeration.toFixed(1);

    console.log(newExaggeration)
    // æ›´æ–°åœ°å½¢å¤¸å¤§ç³»æ•°
    viewer.scene.globe.terrainExaggeration = newExaggeration;

    // æ‰‹åŠ¨è¯·æ±‚ä¸€æ¬¡åœºæ™¯é‡ç»˜ï¼Œä»¥åº”ç”¨æ›´æ”¹
    viewer.scene.requestRender();
  });

  document.getElementById('imageryAlpha').addEventListener('input', (e) => {
    const alpha = parseFloat(e.target.value);
    document.getElementById('imageryAlphaValue').textContent = alpha.toFixed(1);
    if (viewer.imageryLayers.length > 0) {
      viewer.imageryLayers.get(0).alpha = alpha;
    }
  });

  document.getElementById('slopeAlpha').addEventListener('input', (e) => {
    const alpha = parseFloat(e.target.value);
    document.getElementById('slopeAlphaValue').textContent = alpha.toFixed(1);
    // æ›´æ–°å¡åº¦å›¾å±‚é€æ˜åº¦
  });

  // åˆ‡æ¢æŒ‰é’®
  document.getElementById('toggleImagery').addEventListener('click', function() {
    this.classList.toggle('active');
    imageryLayerVisible = !imageryLayerVisible;
    if (viewer.imageryLayers.length > 0) {
      viewer.imageryLayers.get(0).show = imageryLayerVisible;
    }
  });

  document.getElementById('toggleSlope').addEventListener('click', function() {
    this.classList.toggle('active');
    slopeLayerVisible = !slopeLayerVisible;
    document.getElementById('slopeLegend').style.display = slopeLayerVisible ? 'block' : 'none';
  });

  document.getElementById('toggleContour').addEventListener('click', function() {
    this.classList.toggle('active');
    // åˆ‡æ¢ç­‰é«˜çº¿æ˜¾ç¤º
  });

  // --- åœ°å½¢é˜´å½± ---
  // é¦–å…ˆï¼Œåœ¨ viewer åˆå§‹åŒ–åï¼ŒåŒæ­¥æŒ‰é’®çš„åˆå§‹çŠ¶æ€
  const toggleShadowBtn = document.getElementById('toggleShadow');

  // æˆ‘ä»¬çš„ enableLighting é»˜è®¤ä¸º trueï¼Œæ‰€ä»¥è®©æŒ‰é’®ä¹Ÿæ¿€æ´»
  if (viewer.scene.globe.enableLighting) {
    toggleShadowBtn.classList.add('active');
  }

  toggleShadowBtn.addEventListener('click', function() {
    this.classList.toggle('active');
    const shadowsEnabled = this.classList.contains('active');

    // å¼€å¯æˆ–å…³é—­å…‰ç…§
    viewer.scene.globe.enableLighting = shadowsEnabled;

    if (shadowsEnabled) {
      // å¦‚æœå¼€å¯é˜´å½±ï¼Œè®¾ç½®ä¸€ä¸ªå®¹æ˜“è§‚å¯Ÿåˆ°é˜´å½±çš„æ—¶é—´ï¼ˆä¾‹å¦‚ï¼Œè®¾ç½®ä¸ºä¸‹åˆ4ç‚¹ï¼‰
      const specificTime = Cesium.JulianDate.fromIso8601("2025-07-12T16:00:00Z");
      viewer.clock.currentTime = specificTime;
      // ç¡®ä¿æ—¶é—´è½´åŠ¨ç”»æš‚åœï¼Œä»¥ä¿æŒåœ¨è¯¥æ—¶åˆ»
      viewer.clock.shouldAnimate = false;
    }

    // è¯·æ±‚æ¸²æŸ“ä»¥æ›´æ–°è§†å›¾
    viewer.scene.requestRender();
  });

  // è§†è§’æ¨¡å¼
  document.getElementById('viewOverview').addEventListener('click', () => {
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(116.3974, 39.9093, 50000),
      orientation: {
        heading: 0,
        pitch: Cesium.Math.toRadians(-90),
        roll: 0
      }
    });
  });

  document.getElementById('viewDetail').addEventListener('click', () => {
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(116.3974, 39.9093, 2000),
      orientation: {
        heading: 0,
        pitch: Cesium.Math.toRadians(-30),
        roll: 0
      }
    });
  });

  document.getElementById('viewFly').addEventListener('click', () => {
    // å¼€å§‹é£è¡Œæ¨¡å¼
    const flyPath = [
      {lon: 116.37, lat: 39.88, height: 1500},
      {lon: 116.40, lat: 39.90, height: 2000},
      {lon: 116.42, lat: 39.92, height: 1800},
      {lon: 116.39, lat: 39.91, height: 1600}
    ];

    let currentIndex = 0;
    function flyToNext() {
      if (currentIndex >= flyPath.length) {
        currentIndex = 0;
      }
      const point = flyPath[currentIndex];
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(point.lon, point.lat, point.height),
        duration: 3,
        complete: () => {
          currentIndex++;
          viewer.scene.requestRender();
          setTimeout(flyToNext, 1000);
        }
      });
    }
    flyToNext();
  });

  // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - æ˜¾ç¤ºä½ç½®ä¿¡æ¯
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  handler.setInputAction((movement) => {
    const cartesian = viewer.camera.pickEllipsoid(movement.endPosition, viewer.scene.globe.ellipsoid);
    if (cartesian) {
      const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
      const longitude = Cesium.Math.toDegrees(cartographic.longitude);
      const latitude = Cesium.Math.toDegrees(cartographic.latitude);

      // è·å–åœ°å½¢é«˜åº¦
      const terrainProvider = viewer.terrainProvider;
      Cesium.sampleTerrainMostDetailed(terrainProvider, [cartographic]).then((updatedPositions) => {
        const height = updatedPositions[0].height || 0;

        document.getElementById('longitude').textContent = longitude.toFixed(6) + 'Â°';
        document.getElementById('latitude').textContent = latitude.toFixed(6) + 'Â°';
        document.getElementById('elevation').textContent = height.toFixed(1) + ' m';

        // è®¡ç®—å¡åº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const slope = Math.random() * 30;  // å®é™…é¡¹ç›®ä¸­éœ€è¦æ ¹æ®DEMè®¡ç®—
        document.getElementById('slope').textContent = slope.toFixed(1) + 'Â°';

        document.getElementById('dataPanel').classList.add('show');
      });
    }
  }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

  // æ·»åŠ ç²’å­æ•ˆæœï¼ˆå¯é€‰ï¼‰
  function addParticleSystem() {
    const particleSystem = viewer.scene.primitives.add(new Cesium.ParticleSystem({
      image: './particle.png',  // éœ€è¦ç²’å­å›¾ç‰‡
      startColor: Cesium.Color.CYAN.withAlpha(0.7),
      endColor: Cesium.Color.WHITE.withAlpha(0.0),
      startScale: 1.0,
      endScale: 5.0,
      minimumParticleLife: 1.0,
      maximumParticleLife: 3.0,
      minimumSpeed: 5.0,
      maximumSpeed: 10.0,
      imageSize: new Cesium.Cartesian2(20, 20),
      emissionRate: 50.0,
      lifetime: 16.0,
      emitter: new Cesium.CircleEmitter(1000.0),
      modelMatrix: Cesium.Matrix4.fromTranslation(Cesium.Cartesian3.fromDegrees(116.3974, 39.9093, 1000)),
      emitterModelMatrix: Cesium.Matrix4.fromTranslation(new Cesium.Cartesian3(0.0, 0.0, 100.0))
    }));
  }

  // é”®ç›˜å¿«æ·é”®
  document.addEventListener('keydown', (e) => {
    switch(e.key) {
      case 'h':  // æ˜¾ç¤º/éšè—UI
        document.querySelector('.control-panel').style.display =
                document.querySelector('.control-panel').style.display === 'none' ? 'block' : 'none';
        break;
      case 'r':  // é‡ç½®è§†è§’
        viewer.camera.flyHome(1.5);
        break;
      case 'f':  // å…¨å±
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
        break;
    }
  });
</script>
</body>
</html>
